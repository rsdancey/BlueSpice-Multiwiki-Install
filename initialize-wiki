#!/bin/bash

# BlueSpice Wiki Initialization Script
# Complete setup wizard for new BlueSpice wiki instances

set -euo pipefail

# Script directory and paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WIKIS_DIR="$(dirname "${SCRIPT_DIR}")/wikis"
TEMPLATE_DIR="${SCRIPT_DIR}/wiki-template"

# Default values
WIKI_NAME=""
WIKI_DOMAIN=""
WIKI_LANG="en"
SETUP_MODE=""
SKIP_DIRECTORY_SETUP=false
SSL_ENABLED=false

# SSL Certificate functions
check_certificate_expiry() {
    local domain="$1"
    
    if docker exec bluespice-letsencrypt-service test -f "/etc/nginx/certs/${domain}.crt" 2>/dev/null; then
        local expiry expiry_epoch current_epoch days_until_expiry
        expiry=$(docker exec bluespice-letsencrypt-service openssl x509 -in "/etc/nginx/certs/${domain}.crt" -noout -enddate | cut -d= -f2)
        expiry_epoch=$(date -d "$expiry" +%s)
        current_epoch=$(date +%s)
        days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))
        
        if [[ $days_until_expiry -lt 30 ]]; then
            echo "Warning: SSL certificate expires in $days_until_expiry days"
            return 1
        else
            echo "SSL certificate valid for $days_until_expiry days"
            return 0
        fi
    else
        echo "No SSL certificate found for $domain"
        return 1
    fi
}


# SMTP password validation function
validate_smtp_pass() {
    local password="$1"
    # Check if password contains spaces
    if [[ "$password" =~ [[:space:]] ]]; then
        return 1
    fi
    return 0
}


# SMTP host validation function
validate_smtp_host() {
    local host="$1"
    # Check if host follows basic hostname format
    if [[ ! "$host" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$ ]]; then
        return 1
    fi
    # Check if host contains at least one dot (domain format)
    if [[ ! "$host" =~ . ]]; then
        return 1
    fi
    return 0
}


# Environment file creation
create_environment_file() {
    local wiki_dir="${WIKIS_DIR}/${WIKI_NAME}"
    local env_file="${wiki_dir}/.env"
    local template_file="${TEMPLATE_DIR}/.env.template"
    
    if [[ -f "$template_file" ]]; then
        echo "Creating environment file from template..."
        
        # Generate random password
        local db_password
        db_password=$(openssl rand -base64 16 | tr -d "=+/")
        
        # Copy template and substitute variables
        sed \
            -e "s/WIKI_NAME_PLACEHOLDER/${WIKI_NAME}/g" \
            -e "s/WIKI_DOMAIN_PLACEHOLDER/${WIKI_DOMAIN}/g" \
            -e "s/WIKI_LANG_PLACEHOLDER/${WIKI_LANG}/g" \
            -e "s/WIKI_DB_PASSWORD_PLACEHOLDER/${db_password}/g" \
            -e "s/SMTP_HOST_PLACEHOLDER/${SMTP_HOST}/g" \
            -e "s/SMTP_PORT_PLACEHOLDER/${SMTP_PORT}/g" \
            -e "s/SMTP_USER_PLACEHOLDER/${SMTP_USER}/g" \
            -e "s/SMTP_PASS_PLACEHOLDER/${SMTP_PASS}/g" \
            "$template_file" > "$env_file"
        
        echo "Environment file created: $env_file"
    else
        echo "Error: Template file not found: $template_file" >&2
        exit 1
    fi
}

# Wiki directory setup
setup_wiki_directory() {
    local wiki_dir="${WIKIS_DIR}/${WIKI_NAME}"
    
    echo "Setting up wiki directory: $wiki_dir"
    mkdir -p "$wiki_dir"
    
    if [[ "$SETUP_MODE" == "restore" ]]; then
        echo "Preparing directory for backup restoration..."
        # Copy essential files only
        cp "${TEMPLATE_DIR}/docker-compose."* "$wiki_dir/"
    else
        echo "Copying template files..."
        cp -r "${TEMPLATE_DIR}/"* "$wiki_dir/"
    fi
    
    echo "Wiki directory prepared"
}

# Wiki deployment
deploy_wiki() {
    local wiki_dir="${WIKIS_DIR}/${WIKI_NAME}"
    
    echo "Deploying wiki instance..."
    
    cd "$wiki_dir"
    
    # Deploy with fresh installation
    if ! "${SCRIPT_DIR}/bluespice-deploy-wiki" \
        --wiki-name="$WIKI_NAME" \
         \
        --fresh-install; then
        echo "Error: Wiki deployment failed" >&2
        exit 1
    fi
    
    echo "Wiki deployed successfully"
}

# SSL setup
setup_ssl() {
    if [[ "$SETUP_MODE" == "ssl" ]] || [[ "$SSL_ENABLED" == "true" ]]; then
        echo "SSL certificate will be automatically generated by Let's Encrypt"
        echo "This may take a few minutes..."
    fi
}

# Backup restoration function using proper MediaWiki maintenance approach
restore_from_backup() {
    local backup_file="$1"
    local wiki_dir="${WIKIS_DIR}/${WIKI_NAME}"
    
    echo "Starting backup restoration using MediaWiki maintenance system..."
    
    # Check if backup file exists
    if [[ ! -f "$backup_file" ]]; then
        echo "Error: Backup file not found: $backup_file" >&2
        return 1
    fi
    
    # Determine file type and prepare for restoration
    local file_ext="${backup_file##*.}"
    local temp_sql="/tmp/restore_backup.sql"
    
    echo "Preparing backup file for restoration..."
    
    # Handle different file formats
    case "$file_ext" in
        "gz")
            echo "Decompressing gzip file..."
            if ! gunzip -c "$backup_file" > "$temp_sql"; then
                echo "Error: Failed to decompress backup file" >&2
                return 1
            fi
            ;;
        "sql")
            echo "Using SQL file directly..."
            cp "$backup_file" "$temp_sql"
            ;;
        *)
            echo "Error: Unsupported backup file format. Supported: .sql, .sql.gz" >&2
            return 1
            ;;
    esac
    
    # Check if it is a SQL dump (not XML)
    if head -5 "$temp_sql" | grep -q "MySQL dump\|MariaDB dump\|-- Dump completed"; then
        echo "Detected SQL database dump - using database restoration method"
        
        # Get database credentials
        # Get database credentials
        local db_name
        local db_user
        local db_pass
        db_name=$(grep DB_NAME "$wiki_dir/.env" | cut -d= -f2)
        db_user=$(grep DB_USER "$wiki_dir/.env" | cut -d= -f2)
        db_pass=$(grep DB_PASS "$wiki_dir/.env" | cut -d= -f2)
        
        echo "Restoring database from SQL dump..."
        
        # Copy SQL file to database container and import
        if docker cp "$temp_sql" bluespice-database:/tmp/restore.sql; then
            echo "SQL file copied to database container"
        else
            echo "Error: Failed to copy SQL file to database container" >&2
            return 1
        fi
        
        # Import the SQL dump using the database container
        if docker exec bluespice-database sh -c "mariadb -u $db_user -p$db_pass $db_name < /tmp/restore.sql"; then
            echo "✓ Database restored successfully from SQL dump"
        else
            echo "Error: Database restoration failed" >&2
            return 1
        fi
        
        # Clean up the temporary file in database container
        docker exec bluespice-database rm -f /tmp/restore.sql
        
    elif head -5 "$temp_sql" | grep -q "<mediawiki\|<siteinfo"; then
        echo "Detected MediaWiki XML dump - using importDump.php"
        
        # Copy XML file to wiki container
        docker cp "$temp_sql" "bluespice-${WIKI_NAME}-wiki-web:/tmp/restore.xml"
        
        # Use MediaWiki importDump maintenance script
        if docker exec "bluespice-${WIKI_NAME}-wiki-web" php /app/bluespice/w/maintenance/importDump.php /tmp/restore.xml; then
            echo "✓ Wiki content restored successfully from XML dump"
        else
            echo "Error: XML dump import failed" >&2
            return 1
        fi
        
        # Clean up
        docker exec "bluespice-${WIKI_NAME}-wiki-web" rm -f /tmp/restore.xml
        
    else
        echo "Error: Unable to determine backup file format (not SQL or XML)" >&2
        return 1
    fi
    
    # Run MediaWiki maintenance updates after restoration
    echo "Running MediaWiki maintenance updates..."
    
    # Update database schema and cache
    if docker exec "bluespice-${WIKI_NAME}-wiki-web" php /app/bluespice/w/maintenance/update.php --quick; then
        echo "✓ Database schema updated"
    else
        echo "Warning: Database schema update encountered issues"
    fi
    
    # Rebuild recent changes
    echo "Rebuilding recent changes..."
    docker exec "bluespice-${WIKI_NAME}-wiki-web" php /app/bluespice/w/maintenance/rebuildrecentchanges.php || true
    
    # Clean up local temporary files
    rm -f "$temp_sql"
    
    echo "✓ Backup restoration completed successfully using MediaWiki maintenance system!"
    return 0
}



# Display completion information
show_completion_info() {
    echo
    echo "================================================"
    echo "Wiki initialization completed successfully!"
    echo "================================================"
    echo
    echo "Wiki Details:"
    echo "  Name: $WIKI_NAME"
    echo "  Domain: $WIKI_DOMAIN"
    echo "  Language: $WIKI_LANG"
    echo
    
    if [[ "$SETUP_MODE" == "ssl" ]] || [[ "$SSL_ENABLED" == "true" ]]; then
        echo "  URL: https://$WIKI_DOMAIN"
        echo "  SSL: Enabled"
    else
        echo "  URL: http://$WIKI_DOMAIN"
        echo "  SSL: Disabled"
    fi
    
    echo
    echo "Next steps:"
    echo "1. Access your wiki at the URL above"
    echo "2. Log in with the default admin credentials"
    echo "3. Configure your wiki settings"
    echo
    echo "Management commands:"
    echo "  Start:  ./bluespice-deploy-wiki --wiki-name=$WIKI_NAME --domain=$WIKI_DOMAIN"
    echo "  Stop:   docker compose -f /core/wikis/$WIKI_NAME/docker-compose.helper-service.yml -f /core/wikis/$WIKI_NAME/docker-compose.main.yml down"
    echo "  Update: ./bluespice-deploy-wiki --wiki-name=$WIKI_NAME --domain=$WIKI_DOMAIN --run-update"
    echo
}

# Main execution
main() {
    echo "BlueSpice Wiki Initialization Wizard"
    echo "======================================"
    echo
    
    # Get wiki name with proper directory checking
    while [[ -z "$WIKI_NAME" ]]; do
        printf "Enter wiki name (alphanumeric, dots, dashes, underscores, no spaces): "; read -r WIKI_NAME
        if [[ ! "$WIKI_NAME" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "Error: Wiki name must be alphanumeric, dots, dashes, underscores with no spaces" >&2
            WIKI_NAME=""
        elif [[ -d "${WIKIS_DIR}/${WIKI_NAME}" ]]; then
            echo
            echo "Warning: Wiki directory '${WIKIS_DIR}/${WIKI_NAME}' already exists"
            echo "This may contain data from a previous installation."
            echo
            printf "Remove existing directory and continue? [y/N]: "; read -r confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                echo "Removing existing directory..."
                if rm -rf "${WIKIS_DIR:?}/${WIKI_NAME:?}"; then
                    echo "Existing directory removed"
                else
                    echo "Error: Failed to remove existing directory" >&2
                    echo "Setup cancelled." >&2
                    exit 1
                fi
            else
                echo "Using existing directory - continuing with current setup..."
                SKIP_DIRECTORY_SETUP=true
            fi
        fi
    done
    
    # Skip input collection if using existing directory
    if [[ "$SKIP_DIRECTORY_SETUP" != "true" ]]; then
    # Get wiki domain
    while [[ -z "$WIKI_DOMAIN" ]]; do
        printf "Enter wiki domain (e.g., wiki.example.com): "; read -r WIKI_DOMAIN
        if [[ ! "$WIKI_DOMAIN" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "Error: Please enter a valid domain name" >&2
            WIKI_DOMAIN=""
        fi
    done
    
    # Get wiki language
    echo "Available languages: en, de, fr, es, it, pt, nl, pl, ru, ja, zh"
    printf "Enter wiki language code [en]: "; read -r WIKI_LANG
    WIKI_LANG="${WIKI_LANG:-en}"
    
    # Get SMTP configuration
    echo
    echo "SMTP Configuration:"
    echo "Configure email settings for wiki notifications"
    echo
    
    printf "Enter SMTP host: "; read -r SMTP_HOST
    while [[ -z "$SMTP_HOST" ]] || ! validate_smtp_host "$SMTP_HOST"; do
        if [[ -z "$SMTP_HOST" ]]; then
            echo "Error: SMTP host cannot be empty"
        else
            echo "Error: Invalid SMTP host format. Please enter a valid hostname (e.g., smtp.gmail.com)"
        fi
        printf "Enter SMTP host: "; read -r SMTP_HOST
    done
    
    printf "Enter SMTP port [587]: "; read -r SMTP_PORT
    SMTP_PORT="${SMTP_PORT:-587}"
    
    printf "Enter SMTP username: "; read -r SMTP_USER
    while [[ -z "$SMTP_USER" ]]; do
        echo "Error: SMTP username cannot be empty"
        printf "Enter SMTP username: "; read -r SMTP_USER
    done
    
    printf "Enter SMTP password: "; read -r SMTP_PASS
    echo
    while [[ -z "$SMTP_PASS" ]] || ! validate_smtp_pass "$SMTP_PASS"; do
        if [[ -z "$SMTP_PASS" ]]; then
            echo "Error: SMTP password cannot be empty"
        elif [[ "$SMTP_PASS" =~ [[:space:]] ]]; then
            echo "Error: SMTP password cannot contain spaces. Please enter a password without spaces."
        fi
        printf "Enter SMTP password: "; read -r SMTP_PASS
        echo
    done
    
    else
        echo "Loading existing configuration..."
        # Load existing configuration from .env file
        local env_file="${WIKIS_DIR}/${WIKI_NAME}/.env"
        if [[ -f "$env_file" ]]; then
            WIKI_DOMAIN=$(grep "^WIKI_HOST=" "$env_file" | cut -d= -f2 2>/dev/null || echo "")
            WIKI_LANG=$(grep "^WIKI_LANG=" "$env_file" | cut -d= -f2 2>/dev/null || echo "en")
            SMTP_HOST=$(grep "^SMTP_HOST=" "$env_file" | cut -d= -f2 2>/dev/null || echo "")
            SMTP_PORT=$(grep "^SMTP_PORT=" "$env_file" | cut -d= -f2 2>/dev/null || echo "587")
            SMTP_USER=$(grep "^SMTP_USER=" "$env_file" | cut -d= -f2 2>/dev/null || echo "")
            # Detect SSL configuration
            local letsencrypt_host=$(grep "^LETSENCRYPT_HOST=" "$env_file" | cut -d= -f2 2>/dev/null || echo "")
            if [[ -n "$letsencrypt_host" ]]; then
                # SSL is configured in existing setup
                SSL_ENABLED=true
                echo "  SSL: Enabled (existing configuration)"
            else
                SSL_ENABLED=false
                echo "  SSL: Not configured"
            fi
            echo "Loaded existing configuration:"
            echo "  Domain: $WIKI_DOMAIN"
            echo "  Language: $WIKI_LANG"
            if [[ -n "$SMTP_HOST" ]]; then
                echo "  SMTP Host: $SMTP_HOST"
            fi
            if [[ -n "$SMTP_USER" ]]; then
                echo "  SMTP User: $SMTP_USER"
            fi
        else
            echo "Warning: No .env file found in existing directory"
            WIKI_DOMAIN=""
            WIKI_LANG="en"
        fi
    fi
    
    # Get setup mode
    echo
    echo "Setup options:"
    echo "1) New wiki with SSL certificate"
    echo "2) New wiki without SSL (HTTP only)"
    echo "3) Restore from backup"
    
    local choice=""
    while [[ ! "$choice" =~ ^[1-3]$ ]]; do
        printf "Choose option [1/2/3]: "; read -r choice
    done
    
    case $choice in
        1) SETUP_MODE="ssl" ;;
        2) SETUP_MODE="http" ;;
        3) 
            SETUP_MODE="restore"
            echo
            echo "Backup File Selection:"
            printf "Enter path to backup file (.sql or .sql.gz): "; read -r BACKUP_FILE
            while [[ -z "$BACKUP_FILE" ]] || [[ ! -f "$BACKUP_FILE" ]]; do
                if [[ -z "$BACKUP_FILE" ]]; then
                    echo "Error: Backup file path cannot be empty"
                elif [[ ! -f "$BACKUP_FILE" ]]; then
                    echo "Error: File not found: $BACKUP_FILE"
                fi
                printf "Enter path to backup file (.sql or .sql.gz): "; read -r BACKUP_FILE
            done
            echo "Selected backup file: $BACKUP_FILE"
            ;;
    esac
    
    # Show configuration summary
    echo
    echo "Configuration Summary:"
    echo "  Wiki Name: $WIKI_NAME"
    echo "  Domain: $WIKI_DOMAIN"
    echo "  Language: $WIKI_LANG"
    echo "  Setup Mode: $SETUP_MODE"
    echo
    echo "  SMTP Host: $SMTP_HOST"
    echo "  SMTP Port: $SMTP_PORT"
    echo "  SMTP User: $SMTP_USER"
    if [[ "$SETUP_MODE" == "restore" ]]; then
        echo "  Backup File: $BACKUP_FILE"
    fi
    
    printf "Proceed with this configuration? [y/N]: "; read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Setup cancelled."
        exit 0
    fi
    
    echo
    echo "Starting wiki initialization..."
    
    # Setup process
    if [[ "$SKIP_DIRECTORY_SETUP" != "true" ]]; then
        setup_wiki_directory
        create_environment_file
    else
        echo "Using existing directory - skipping directory and environment setup"
    fi
    deploy_wiki
    
    # Handle backup restoration if selected
    if [[ "$SETUP_MODE" == "restore" ]]; then
        if ! restore_from_backup "$BACKUP_FILE"; then
            echo "Error: Backup restoration failed" >&2
            exit 1
        fi
    fi
    setup_ssl
    
    # Show completion information
    show_completion_info
}

# Run main function if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
